import{buildOr as r,buildAnd as n,CompoundCondition as t}from"@ucast/mongo2js";function e(r){return Array.isArray(r)?r:[r]}function i(r,n,t){var e=r;var i=n;if(n.indexOf(".")!==-1){var u=n.split(".");i=u.pop();e=u.reduce((function(r,n){r[n]=r[n]||{};return r[n]}),r)}e[i]=t}var u=function r(n){return Array.isArray(n)?n.join(","):n};function o(r,n){return r.map((function(r){var t=[u(r.action||r.actions),typeof n==="function"?e(r.subject).map(n).join(","):u(r.subject),r.conditions||0,r.inverted?1:0,r.fields?u(r.fields):0,r.reason||""];while(t.length>0&&!t[t.length-1])t.pop();return t}))}function f(r,n){return r.map((function(r){var t=r[0],e=r[1],i=r[2],u=r[3],o=r[4],f=r[5];var a=e.split(",");var c={inverted:!!u,action:t.split(","),subject:typeof n==="function"?a.map(n):a};if(i)c.conditions=i;if(o)c.fields=o.split(",");if(f)c.reason=f;return c}))}function a(r,n,t,e){var i=r.detectSubjectType(t);var u=r.possibleRulesFor(n,i);var o=new Set;var f=o.delete.bind(o);var a=o.add.bind(o);var c=u.length;while(c--){var v=u[c];if(v.matchesConditions(t)){var s=v.inverted?f:a;e.fieldsFrom(v).forEach(s)}}return Array.from(o)}var c=function(){function r(r,n,t){this.t=r;this.i=n;this.u=t}var n=r.prototype;n.ofType=function r(n){return a(this.t,this.i,n,{fieldsFrom:this.o(n)})};n.of=function r(n){return a(this.t,this.i,n,{fieldsFrom:this.o(this.t.detectSubjectType(n))})};n.o=function r(n){var t=this;return function(r){return r.fields||t.u(n)}};return r}();function v(r,n,t){return r.rulesFor(n,t).reduce((function(r,n){if(n.inverted||!n.conditions)return r;return Object.keys(n.conditions).reduce((function(r,t){var e=n.conditions[t];if(!e||e.constructor!==Object)i(r,t,e);return r}),r)}),{})}function s(r,n,t,e){var i={};var u=r.rulesFor(n,t);for(var o=0;o<u.length;o++){var f=u[o];var a=f.inverted?"$and":"$or";if(!f.conditions)if(f.inverted)break;else{delete i[a];return i}else{i[a]=i[a]||[];i[a].push(e(f))}}return i.$or?i:null}function h(r){if(!r.ast)throw new Error('Ability rule "'+JSON.stringify(r)+'" does not have "ast" property. So, cannot be used to generate AST');return r.inverted?new t("not",[r.ast]):r.ast}function l(t,e,i){var u=s(t,e,i,h);if(u===null)return null;if(!u.$and)return u.$or?r(u.$or):n([]);if(u.$or)u.$and.push(r(u.$or));return n(u.$and)}export{c as AccessibleFields,o as packRules,a as permittedFieldsOf,l as rulesToAST,v as rulesToFields,s as rulesToQuery,f as unpackRules};
//# sourceMappingURL=index.js.map
