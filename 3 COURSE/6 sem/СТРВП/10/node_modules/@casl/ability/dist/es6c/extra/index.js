"use strict";var t=require("@ucast/mongo2js");function n(t){return Array.isArray(t)?t:[t]}function r(t,n,r){let e=t;let o=n;if(n.indexOf(".")!==-1){const r=n.split(".");o=r.pop();e=r.reduce(((t,n)=>{t[n]=t[n]||{};return t[n]}),t)}e[o]=r}const e=t=>Array.isArray(t)?t.join(","):t;function o(t,r){return t.map((t=>{const o=[e(t.action||t.actions),typeof r==="function"?n(t.subject).map(r).join(","):e(t.subject),t.conditions||0,t.inverted?1:0,t.fields?e(t.fields):0,t.reason||""];while(o.length>0&&!o[o.length-1])o.pop();return o}))}function s(t,n){return t.map((([t,r,e,o,s,i])=>{const u=r.split(",");const c={inverted:!!o,action:t.split(","),subject:typeof n==="function"?u.map(n):u};if(e)c.conditions=e;if(s)c.fields=s.split(",");if(i)c.reason=i;return c}))}function i(t,n,r,e){const o=t.detectSubjectType(r);const s=t.possibleRulesFor(n,o);const i=new Set;const u=i.delete.bind(i);const c=i.add.bind(i);let f=s.length;while(f--){const t=s[f];if(t.matchesConditions(r)){const n=t.inverted?u:c;e.fieldsFrom(t).forEach(n)}}return Array.from(i)}class u{constructor(t,n,r){this.t=t;this.o=n;this.i=r}ofType(t){return i(this.t,this.o,t,{fieldsFrom:this.u(t)})}of(t){return i(this.t,this.o,t,{fieldsFrom:this.u(this.t.detectSubjectType(t))})}u(t){return n=>n.fields||this.i(t)}}function c(t,n,e){return t.rulesFor(n,e).reduce(((t,n)=>{if(n.inverted||!n.conditions)return t;return Object.keys(n.conditions).reduce(((t,e)=>{const o=n.conditions[e];if(!o||o.constructor!==Object)r(t,e,o);return t}),t)}),{})}function f(t,n,r,e){const o={};const s=t.rulesFor(n,r);for(let t=0;t<s.length;t++){const n=s[t];const r=n.inverted?"$and":"$or";if(!n.conditions)if(n.inverted)break;else{delete o[r];return o}else{o[r]=o[r]||[];o[r].push(e(n))}}return o.$or?o:null}function l(n){if(!n.ast)throw new Error(`Ability rule "${JSON.stringify(n)}" does not have "ast" property. So, cannot be used to generate AST`);return n.inverted?new t.CompoundCondition("not",[n.ast]):n.ast}function h(n,r,e){const o=f(n,r,e,l);if(o===null)return null;if(!o.$and)return o.$or?t.buildOr(o.$or):t.buildAnd([]);if(o.$or)o.$and.push(t.buildOr(o.$or));return t.buildAnd(o.$and)}exports.AccessibleFields=u;exports.packRules=o;exports.permittedFieldsOf=i;exports.rulesToAST=h;exports.rulesToFields=c;exports.rulesToQuery=f;exports.unpackRules=s;
//# sourceMappingURL=index.js.map
